#include <omp.h>
#include <iostream>
#include "cblas.h"
#include <cmath>
#include <iostream>
#include <string>

#include <omp.h>
#include "math.h"
#include "time.h"
#include <omp.h>

//blas
static void MatrixMul(bool transA, bool transB, const double* A, const double* B, double* C, int m, int n, int k, const double* scalarA = nullptr, const double* scalarB = nullptr,
		int lda = 0, int ldb = 0, int ldc = 0) {

	auto TRANS_A = transA ? CblasTrans : CblasNoTrans;
	auto TRANS_B = transB ? CblasTrans : CblasNoTrans;

	if (lda == 0)
		lda = m;
	if (ldb == 0)
		ldb = n;
	if (ldc == 0)
		ldc = m;

	const double beta = scalarB ? *scalarB : 0.0;
	const double alpha = scalarA ? *scalarA : 1.0;
	cblas_dgemm(CblasColMajor, TRANS_A, TRANS_B, m, n, k, alpha, A, lda, B, ldb, beta, C, ldc);
}

static void MatrixMulMe(bool transA, bool transB, const double* A, const double* B, double* C, int m, int n, int k, const double* scalarA = nullptr, const double* scalarB = nullptr,
		int lda = 0, int ldb = 0, int ldc = 0) {

	auto TRANS_A = transA ? CblasTrans : CblasNoTrans;
	auto TRANS_B = transB ? CblasTrans : CblasNoTrans;

	if (lda == 0)
		lda = m;
	if (ldb == 0)
		ldb = n;
	if (ldc == 0)
		ldc = m;

	const double beta = scalarB ? *scalarB : 0.0;
	const double alpha = scalarA ? *scalarA : 1.0;

	/*
	 * a = M x K
	 * b = K x N
	 * c = M x N
	 */

	for (int _m = 0; _m < m; ++_m) {
		for (int _n = 0; _n < n; ++_n) {
			double sum = 0;
			for (int _k = 0; _k < k; ++_k) {
				sum += A[_m + _k * lda] * B[_n * ldb + _k];
			}
			C[_n * ldc + _m] = sum;
		}
	}
}

void testSpeed(int size, int reps) {

	double* a = new double[size * size];
	double* b = new double[size * size];
	double* c = new double[size * size];

	for (int i = 0; i < size*size; ++i) {
		b[i] = i;
		a[i] = i;
	}

	float t = omp_get_wtime();
	for (int iter = 0; iter < reps; ++iter) {
		MatrixMul(false, false, a, b, c, size, size, size);
	}
	t = omp_get_wtime() - t;


	float t2 = omp_get_wtime();

	for (int iter = 0; iter < reps; ++iter) {
		MatrixMulMe(false, false, a, b, c, size, size, size);
	}
	t2 = omp_get_wtime() - t2;

	std::cout.precision(8);
	std::cout << "BLAS: sz = " << size << "  time: " << t  << "   ||" << "ME: sz = " << size << "  time: " << t2  <<std::endl;
//
//		for (int i = 0; i < size*size; ++i) {
//			std::cout << c[i] << std::endl;
//		}



}

int main() {
	for (int i = 16; i < 1000; i*= 2)
		testSpeed(i, 100);
}
